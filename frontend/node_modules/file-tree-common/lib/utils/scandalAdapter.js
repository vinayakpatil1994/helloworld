'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var actionCount = 0;

exports.default = function (tree, debug) {
  return function (filepath) {
    var resolved = {};

    _fsExtra2.default.lstat(filepath, function (err, stat) {
      if (err) return;

      if (debug) {
        console.log('filepath-found', actionCount++, '=>', filepath);
      }

      var dir = _path2.default.dirname(filepath);

      if (tree.get(dir)) {
        tree.addFile(filepath, stat);
      } else {
        resolved[dir] = resolved[dir] || new Promise(function (resolve, reject) {
          _fsExtra2.default.lstat(dir, function (err, parentState) {
            if (err) return;

            if (debug) {
              console.log('dir-found', actionCount++, '=>', filepath);
            }

            tree.addDir(dir, parentState);
            resolve();
          });
        });

        resolved[dir].then(function () {
          tree.addDir(filepath, stat);
        });
      }
    });
  };
};